<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Receipt Summarizer（領収書チェッカー）</title>
  <meta name="description" content="領収書をアップロードするだけ。日付・店名・金額を自動整理。TXT/CSV保存は課金後に解放。完全ブラウザ内処理。" />

  <style>
    /* …（スタイルは前回のまま）… */
  </style>

  <!-- OCR / PDF libs -->
  <script src="https://unpkg.com/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    window.pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  </script>
</head>
<body>
  <!-- …（HTML本体は前回のまま）… -->

<script>
/* ===== 前回までの変数・I18N定義・UI関数・OCR処理等は全て同じ ===== */

/* ======== Parsing (JA/EN) ======== */
function parseReceipt(text, filename=""){
  const raw=(text||"").replace(/\r/g,"").trim();
  const lines=raw.split("\n").map(s=>s.trim()).filter(Boolean);

  const date = pickDate(raw);
  let total = pickTotal(lines, raw);

  let store = "";
  for(let i=0;i<Math.min(lines.length,8);i++){
    const s=lines[i]; if(!s) continue;
    if(/[0-9０-９]/.test(s)) continue;
    if(/(〒|TEL|電話|FAX|URL|http|https|税|合計|領収|明細|RECEIPT|INVOICE|SUBTOTAL|TOTAL|AMOUNT)/i.test(s)) continue;
    if(s.length<2) continue;
    store = s.replace(/^[\-\*●\s]+/,"").trim(); if(store) break;
  }
  if(!store && filename) store = filename.replace(/\.(pdf|png|jpe?g)$/i,"");
  return { store, date, total, note:"" };
}

/* ======== 金額抽出強化版 ======== */
function pickTotal(lines, raw) {
  const isNoAmountLine = (s) =>
    /(TEL|電話|FAX|〒|郵便|住所|http|https)/i.test(s) ||
    /\b\d{2,4}-\d{2,4}-\d{3,4}\b/.test(s);

  const totalKey = /(合計金額|総合計|合計|ご請求金額|お会計|お支払金額|税込合計|TOTAL|AMOUNT DUE|Grand Total|Balance Due)/i;
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    if (isNoAmountLine(line)) continue;
    if (totalKey.test(line.replace(/\s/g, ""))) {
      const c0 = findAmountStrict(line);
      if (c0) return c0;
      if (i + 1 < lines.length && !isNoAmountLine(lines[i + 1])) {
        const c1 = findAmountStrict(lines[i + 1]); if (c1) return c1;
      }
      if (i + 2 < lines.length && !isNoAmountLine(lines[i + 2])) {
        const c2 = findAmountStrict(lines[i + 2]); if (c2) return c2;
      }
    }
  }

  const subtotalKey = /(小計|SUBTOTAL)/i;
  const taxKey = /(税|消費税|税込|TAX)/i;
  let subtotal = null, tax = null;
  for (let i = 0; i < lines.length; i++) {
    const s = lines[i]; if (isNoAmountLine(s)) continue;
    if (subtotal === null && subtotalKey.test(s)) {
      subtotal = findAmountStrict(s) || (i + 1 < lines.length ? findAmountStrict(lines[i + 1]) : null);
    }
    if (tax === null && taxKey.test(s)) {
      tax = findAmountStrict(s) || (i + 1 < lines.length ? findAmountStrict(lines[i + 1]) : null);
    }
  }
  if (subtotal && tax) {
    const sum = sumCurrency(subtotal, tax);
    if (sum) return sum;
  }

  const yenOrDollar = [];
  const numericLoose = [];
  for (const s of lines) {
    if (isNoAmountLine(s)) continue;
    const amounts = allAmountsInLine(s);
    for (const a of amounts) {
      if (/[円¥￥$]|USD/i.test(a)) yenOrDollar.push(a);
      else numericLoose.push(a);
    }
  }
  const best = (list) => {
    let pick = "", max = 0;
    for (const a of list) {
      const v = Number(a.replace(/[^\d.]/g, "") || 0);
      if (v > max) { max = v; pick = a; }
    }
    return pick ? normalizeAmountCurrency(pick) : "";
  };
  return best(yenOrDollar) || best(numericLoose) || "";
}

function findAmountStrict(line) {
  if (/\b\d{2,4}-\d{2,4}-\d{3,4}\b/.test(line)) return "";
  if (/〒\s*\d{3}-\d{4}/.test(line)) return "";

  let m = line.match(/([¥￥$]\s*\d{1,3}(?:[,\d]{3})*(?:\.\d{1,2})?)|(\d{1,3}(?:[,\d]{3})*(?:\.\d{1,2})?\s*(円|¥|￥|USD|\$))/i);
  if (m) return normalizeAmountCurrency(m[0]);

  m = line.match(/\b\d{1,3}(?:,\d{3})+(?:\.\d{1,2})?\b/);
  if (m) return normalizeAmountCurrency(m[0]);

  m = line.match(/\b\d{4,}(?:\.\d{1,2})?\b/);
  if (m) return normalizeAmountCurrency(m[0]);

  return "";
}

function allAmountsInLine(line) {
  const out = [];
  const re = /([¥￥$]?\s*\d{1,3}(?:[,\d]{3})*(?:\.\d{1,2})?\s*(円|¥|￥|\$|USD)?)/gi;
  let m;
  while ((m = re.exec(line)) !== null) {
    const s = (m[0] || "").trim();
    if (/\d-\d|〒\s*\d{3}-\d{4}/.test(s)) continue;
    if (/\b20\d{2}\b/.test(s) && !/[円¥￥$]/.test(s)) continue;
    if (s) out.push(s);
  }
  return out;
}

function sumCurrency(a, b) {
  const curA = /USD|\$/i.test(a) ? "$" : /(円|¥|￥)/.test(a) ? "¥" : "";
  const curB = /USD|\$/i.test(b) ? "$" : /(円|¥|￥)/.test(b) ? "¥" : "";
  if (curA && curA === curB) {
    const va = Number(a.replace(/[^\d.]/g, "") || 0);
    const vb = Number(b.replace(/[^\d.]/g, "") || 0);
    return normalizeAmountCurrency(curA + String(va + vb));
  }
  return "";
}
</script>
</body>
</html>
