<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Receipt Summarizer — Patched Index</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:#0b0f14;color:#e5e7eb}
    .card{background:#0f1721;border:1px solid #1f2937}
    .inp{background:#0b1220;border:1px solid #1f2937}
    .inp:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.2)}
  </style>
</head>
<body class="min-h-screen">
  <header class="max-w-5xl mx-auto px-4 py-6">
    <h1 class="text-xl font-bold">Receipt Summarizer — 正規化パッチ適用版</h1>
    <p class="text-sm text-gray-400 mt-1">合計の通貨・小数、日付の統一、空の店舗名を安定化。入力値は自動整形されます。</p>
  </header>

  <main class="max-w-5xl mx-auto px-4">
    <section class="card rounded-2xl p-5">
      <p class="text-sm text-gray-400">Edit values if needed before saving.</p>
      <div class="grid grid-cols-12 mt-4 pb-2 border-b border-slate-700 text-sm font-semibold">
        <div class="col-span-4">Store</div>
        <div class="col-span-3">Date</div>
        <div class="col-span-3">Total</div>
        <div class="col-span-2">Note / Category</div>
      </div>
      <div id="rows"></div>
      <div class="mt-4 text-emerald-400 text-sm" id="status">Done: processed 0</div>
      <div class="mt-2 text-xs text-gray-400">※ 表示は通貨付き、内部は正規化済み数値を保持します。</div>
    </section>

    <section class="mt-6 card rounded-2xl p-5">
      <h2 class="font-semibold">テストデータの読み込み</h2>
      <p class="text-sm text-gray-400">あなたの既存パイプラインに差し替える場合は <code>loadData()</code> を置き換えてください。</p>
      <div class="mt-3 flex gap-2">
        <button id="btn-load" class="px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-500">サンプル2件を読み込み</button>
        <button id="btn-clear" class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">全消去</button>
      </div>
    </section>
  </main>

  <template id="row-tpl">
    <div class="grid grid-cols-12 gap-3 py-3 border-b border-slate-800 items-center">
      <input class="col-span-4 inp rounded-xl px-3 py-2 text-sm store" placeholder="(空)" />
      <input class="col-span-3 inp rounded-xl px-3 py-2 text-sm date" placeholder="YYYY-MM-DD" />
      <input class="col-span-3 inp rounded-xl px-3 py-2 text-sm total" placeholder="¥0 / $0.00" />
      <input class="col-span-2 inp rounded-xl px-3 py-2 text-sm note" placeholder="optional" />
    </div>
  </template>

  <script>
    // ---------------- Normalizers ----------------
    function detectCurrency(s){
      if(!s) return null;
      if(/[¥￥]/.test(s)) return 'JPY';
      if(/\$/.test(s)) return 'USD';
      if(/€/.test(s)) return 'EUR';
      if(/£/.test(s)) return 'GBP';
      return null;
    }

    function cleanupNumericString(raw){
      if(raw==null) return '';
      let s = String(raw).replace(/[Ａ-Ｚａ-ｚ０-９．，]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0xFEE0))
                         .replace(/[^\d.,\-]/g,'')
                         .trim();
      const hasComma = s.includes(',');
      const hasDot = s.includes('.');
      if(hasComma && hasDot){
        if(s.lastIndexOf(',') > s.lastIndexOf('.')){ // 1.234,56
          s = s.replace(/\./g,'').replace(',', '.');
        } else { // 1,234.56
          s = s.replace(/,/g,'');
        }
      } else if(hasComma && !hasDot){
        const tail = s.split(',').pop();
        if(/^\d{1,2}$/.test(tail)) s = s.replace(',', '.'); // 1234,5 -> 1234.5
        else s = s.replace(/,/g,'');
      }
      return s;
    }

    function normalizeTotal(raw, fallbackCurrency='JPY'){
      const currency = detectCurrency(String(raw)) || fallbackCurrency;
      const cleaned = cleanupNumericString(raw);
      const num = parseFloat(cleaned);
      if(!Number.isFinite(num)) return { value:'', currency };
      if(currency==='JPY') return { value: String(Math.round(num)), currency };
      return { value: num.toFixed(2), currency };
    }

    function formatTotalForInput({value, currency}){
      if(value==='') return '';
      const sym = {JPY:'¥', USD:'$', EUR:'€', GBP:'£'}[currency] || '';
      return sym + value;
    }

    function normalizeDate(raw){
      if(!raw) return '';
      let s = String(raw).trim()
        .replace(/[.\/年]/g,'-')
        .replace(/[月]/g,'-')
        .replace(/[日]/g,'');
      const parts = s.split(/[-]/).filter(Boolean).map(p=>p.padStart(2,'0'));
      let y,m,d;
      if(parts.length===3){
        if(parts[0].length===4){ // YYYY-MM-DD
          [y,m,d]=parts;
        } else if(parseInt(parts[2],10)>31){ // DD-MM-YYYY
          [d,m,y]=parts;
        } else { // MM-DD-YYYY
          [m,d,y]=parts;
        }
        const mm = String(Math.min(Math.max(parseInt(m||'1',10),1),12)).padStart(2,'0');
        const dd = String(Math.min(Math.max(parseInt(d||'1',10),1),31)).padStart(2,'0');
        return `${y}-${mm}-${dd}`;
      }
      return s;
    }

    function joinSplitDecimals(raw){
      if(!raw) return raw;
      return String(raw).replace(/\s+/g,' ').replace(/(\d)\s*\.\s*(\d{1,2})/g,'$1.$2');
    }

    // ---------------- Demo State ----------------
    const state = { items: [] };
    const rowsEl = document.getElementById('rows');
    const statusEl = document.getElementById('status');

    function render(){
      rowsEl.innerHTML = '';
      const tpl = document.getElementById('row-tpl');
      state.items.forEach((it, idx)=>{
        const node = tpl.content.cloneNode(true);
        const store = node.querySelector('.store');
        const date = node.querySelector('.date');
        const total = node.querySelector('.total');
        const note = node.querySelector('.note');

        // 初期値（正規化）
        store.value = (it.store||'').trim();
        date.value = normalizeDate(it.date);
        const norm = normalizeTotal(joinSplitDecimals(it.total), 'JPY');
        total.value = formatTotalForInput(norm);
        it._normalizedTotal = norm; // 内部保持
        note.value = it.note || '';

        // 入力時も再正規化
        date.addEventListener('blur', ()=>{ date.value = normalizeDate(date.value); it.date = date.value; });
        total.addEventListener('blur', ()=>{
          const norm2 = normalizeTotal(joinSplitDecimals(total.value), norm.currency || 'JPY');
          total.value = formatTotalForInput(norm2);
          it._normalizedTotal = norm2; it.total = norm2.value;
        });
        store.addEventListener('input', ()=>{ it.store = store.value; });
        note.addEventListener('input', ()=>{ it.note = note.value; });

        rowsEl.appendChild(node);
      });
      statusEl.textContent = `Done: processed ${state.items.length} (Patched)`;
    }

    // ---------------- Demo Loader ----------------
    function loadData(){
      state.items = [
        { store:'', date:'2025-08-10', total:'202', note:'' },
        { store:'Starbucks Tokyo', date:'2025/8/10', total:'$10.90', note:'' }
      ];
      render();
    }
    document.getElementById('btn-load').addEventListener('click', loadData);
    document.getElementById('btn-clear').addEventListener('click', ()=>{ state.items=[]; render(); });

    // 初期表示（空）
    render();
  </script>
</body>
</html>
