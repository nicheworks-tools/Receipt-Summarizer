<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Receipt Summarizer（領収書チェッカー）</title>
  <meta name="description" content="領収書をアップロードするだけ。日付・店名・金額を自動整理。TXT/CSV保存は課金後に解放。完全ブラウザ内処理。" />

  <style>
    :root { --bg:#0b0c10; --card:#11141a; --muted:#9399a1; --fg:#e6e8ea; --acc:#6ee7b7; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    a{color:var(--acc);text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    .hero{background:linear-gradient(180deg,rgba(110,231,183,.08),transparent);border:1px solid #1f2937;padding:24px;border-radius:16px;position:relative}
    .hero h1{margin:0 0 8px;font-size:28px}
    .sub{color:var(--muted);margin:0 0 16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{background:#1f2937;color:#e5e7eb;border:1px solid #374151;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.acc{background:#047857;border-color:#065f46}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #374151;background:#111827;padding:6px 10px;border-radius:999px;color:#e5e7eb}
    .lang{position:absolute;right:16px;top:16px;display:flex;gap:8px}
    .lang button{font-size:12px;padding:6px 10px;border-radius:999px}
    .grid{display:grid;gap:16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px}
    .muted{color:var(--muted)}
    .drop{border:1.5px dashed #334155;border-radius:12px;padding:18px;text-align:center;background:#0f1623;flex:1;min-width:260px}
    .drop.dragover{outline:2px solid #2563eb;outline-offset:2px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #1f2937;vertical-align:top}
    th{color:#cbd5e1;text-align:left}
    input[type="text"]{width:100%;background:#0b1220;border:1px solid #1f2937;border-radius:8px;color:#e5e7eb;padding:8px}
    .kbd{border:1px solid #334155;background:#0b1220;color:#e5e7eb;padding:2px 6px;border-radius:6px}
    .right{display:flex;justify-content:flex-end;gap:8px}
    .small{font-size:12px}
    .badge{display:inline-block;background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:2px 8px;color:#cbd5e1}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .footer{color:#94a3b8;font-size:13px;margin:32px 0}
    .warn{color:#fbbf24} .err{color:#f87171} .ok{color:#34d399}
  </style>

  <!-- OCR / PDF libs -->
  <script src="https://unpkg.com/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    window.pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  </script>
</head>
<body>
  <div class="wrap">
    <section class="hero">
      <div class="lang">
        <button class="btn" data-lang="ja">日本語</button>
        <button class="btn" data-lang="en">English</button>
      </div>
      <h1 id="t-title">Receipt Summarizer（領収書チェッカー）</h1>
      <p class="sub" id="t-sub">領収書をアップロードするだけ。<b>日付・店名・金額</b>を自動整理。</p>
      <div class="row">
        <button id="tryFree" class="btn acc">無料で試す（2枚まで）</button>
        <a id="unlockPaid" class="btn" href="#" rel="noopener">一括保存を解放（200円）</a>
        <span class="pill"><span id="accessState">未購入</span> <span class="badge" id="sessionBadge">session: guest</span></span>
      </div>
    </section>

    <section class="grid" style="margin-top:20px">
      <div class="card">
        <div class="row">
          <div class="drop" id="dropzone">
            <b id="t-drop-1">ここにドラッグ＆ドロップ</b><br/>
            <span id="t-drop-2">または</span> <span class="kbd" id="t-drop-3">ファイルを選択</span>
            <div class="small muted" style="margin-top:8px" id="t-drop-4">対応：JPG / PNG / PDF</div>
            <input id="fileInput" type="file" accept=".jpg,.jpeg,.png,.pdf,image/*,application/pdf" multiple style="display:none" />
          </div>
          <div class="card" style="flex:1; min-width:260px">
            <div class="row">
              <button class="btn" id="selectBtn">ファイル選択</button>
              <button class="btn" id="cameraBtn">カメラで撮影</button>
              <button class="btn" id="clearBtn">リセット</button>
              <span class="badge" id="countBadge">0件</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0" id="t-results">抽出結果</h3>
        <div style="overflow:auto">
          <table id="resultTable">
            <thead>
              <tr>
                <th id="th-store" style="width:30%">店名</th>
                <th id="th-date"  style="width:20%">日付</th>
                <th id="th-total" style="width:20%">合計金額</th>
                <th id="th-note">メモ</th>
              </tr>
            </thead>
            <tbody id="resultBody"></tbody>
          </table>
        </div>
        <div id="log" class="small muted" style="margin-top:12px"></div>
      </div>
    </section>
  </div>

<script>
/* ここに I18N や OCR 関数などの既存ロジックを入れる */
/* 以下は金額抽出強化版の関数群 */

function parseReceipt(text, filename=""){
  const raw=(text||"").replace(/\r/g,"").trim();
  const lines=raw.split("\n").map(s=>s.trim()).filter(Boolean);

  const date = pickDate(raw);
  let total = pickTotal(lines, raw);

  let store = "";
  for(let i=0;i<Math.min(lines.length,8);i++){
    const s=lines[i]; if(!s) continue;
    if(/[0-9０-９]/.test(s)) continue;
    if(/(〒|TEL|電話|FAX|URL|http|https|税|合計|領収|明細|RECEIPT|INVOICE|SUBTOTAL|TOTAL|AMOUNT)/i.test(s)) continue;
    if(s.length<2) continue;
    store = s.replace(/^[\-\*●\s]+/,"").trim(); if(store) break;
  }
  if(!store && filename) store = filename.replace(/\.(pdf|png|jpe?g)$/i,"");
  return { store, date, total, note:"" };
}

function pickTotal(lines, raw) {
  const isNoAmountLine = (s) =>
    /(TEL|電話|FAX|〒|郵便|住所|http|https)/i.test(s) ||
    /\b\d{2,4}-\d{2,4}-\d{3,4}\b/.test(s);

  const totalKey = /(合計金額|総合計|合計|ご請求金額|お会計|お支払金額|税込合計|TOTAL|AMOUNT DUE|Grand Total|Balance Due)/i;
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    if (isNoAmountLine(line)) continue;
    if (totalKey.test(line.replace(/\s/g, ""))) {
      const c0 = findAmountStrict(line);
      if (c0) return c0;
      if (i + 1 < lines.length && !isNoAmountLine(lines[i + 1])) {
        const c1 = findAmountStrict(lines[i + 1]); if (c1) return c1;
      }
      if (i + 2 < lines.length && !isNoAmountLine(lines[i + 2])) {
        const c2 = findAmountStrict(lines[i + 2]); if (c2) return c2;
      }
    }
  }

  const subtotalKey = /(小計|SUBTOTAL)/i;
  const taxKey = /(税|消費税|税込|TAX)/i;
  let subtotal = null, tax = null;
  for (let i = 0; i < lines.length; i++) {
    const s = lines[i]; if (isNoAmountLine(s)) continue;
    if (subtotal === null && subtotalKey.test(s)) {
      subtotal = findAmountStrict(s) || (i + 1 < lines.length ? findAmountStrict(lines[i + 1]) : null);
    }
    if (tax === null && taxKey.test(s)) {
      tax = findAmountStrict(s) || (i + 1 < lines.length ? findAmountStrict(lines[i + 1]) : null);
    }
  }
  if (subtotal && tax) {
    const sum = sumCurrency(subtotal, tax);
    if (sum) return sum;
  }

  const yenOrDollar = [];
  const numericLoose = [];
  for (const s of lines) {
    if (isNoAmountLine(s)) continue;
    const amounts = allAmountsInLine(s);
    for (const a of amounts) {
      if (/[円¥￥$]|USD/i.test(a)) yenOrDollar.push(a);
      else numericLoose.push(a);
    }
  }
  const best = (list) => {
    let pick = "", max = 0;
    for (const a of list) {
      const v = Number(a.replace(/[^\d.]/g, "") || 0);
      if (v > max) { max = v; pick = a; }
    }
    return pick ? normalizeAmountCurrency(pick) : "";
  };
  return best(yenOrDollar) || best(numericLoose) || "";
}

function findAmountStrict(line) {
  if (/\b\d{2,4}-\d{2,4}-\d{3,4}\b/.test(line)) return "";
  if (/〒\s*\d{3}-\d{4}/.test(line)) return "";

  let m = line.match(/([¥￥$]\s*\d{1,3}(?:[,\d]{3})*(?:\.\d{1,2})?)|(\d{1,3}(?:[,\d]{3})*(?:\.\d{1,2})?\s*(円|¥|￥|USD|\$))/i);
  if (m) return normalizeAmountCurrency(m[0]);

  m = line.match(/\b\d{1,3}(?:,\d{3})+(?:\.\d{1,2})?\b/);
  if (m) return normalizeAmountCurrency(m[0]);

  m = line.match(/\b\d{4,}(?:\.\d{1,2})?\b/);
  if (m) return normalizeAmountCurrency(m[0]);

  return "";
}

function allAmountsInLine(line) {
  const out = [];
  const re = /([¥￥$]?\s*\d{1,3}(?:[,\d]{3})*(?:\.\d{1,2})?\s*(円|¥|￥|\$|USD)?)/gi;
  let m;
  while ((m = re.exec(line)) !== null) {
    const s = (m[0] || "").trim();
    if (/\d-\d|〒\s*\d{3}-\d{4}/.test(s)) continue;
    if (/\b20\d{2}\b/.test(s) && !/[円¥￥$]/.test(s)) continue;
    if (s) out.push(s);
  }
  return out;
}

function sumCurrency(a, b) {
  const curA = /USD|\$/i.test(a) ? "$" : /(円|¥|￥)/.test(a) ? "¥" : "";
  const curB = /USD|\$/i.test(b) ? "$" : /(円|¥|￥)/.test(b) ? "¥" : "";
  if (curA && curA === curB) {
    const va = Number(a.replace(/[^\d.]/g, "") || 0);
    const vb = Number(b.replace(/[^\d.]/g, "") || 0);
    return normalizeAmountCurrency(curA + String(va + vb));
  }
  return "";
}

function normalizeAmountCurrency(s){
  const hasUSD = /USD|\$/i.test(s);
  const hasJPY = /(円|¥|￥)/.test(s);
  const currency = hasUSD ? "$" : (hasJPY ? "¥" : "");
  const num = (s||"").replace(/[^0-9.]/g,"");
  if (!num) return "";
  const [int, dec] = num.split(".");
  const intFmt = int.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  return currency + intFmt + (dec ? "." + dec : "");
}
</script>
</body>
</html>
